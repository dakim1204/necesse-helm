name: Publish Helm chart to Harbor (OCI)

permissions:
  contents: write

on:
  push:
    branches:
      - main
    paths:
      - "Chart.yaml"
      - "values.yaml"
      - "templates/**"
      - ".github/workflows/publish-helm-oci.yaml"
  workflow_dispatch: {}

jobs:
  publish-helm-chart:
    runs-on: ubuntu-latest

    env:
      HARBOR_URL: ${{ secrets.HARBOR_URL }}
      HARBOR_USERNAME: ${{ secrets.HARBOR_USERNAME }}
      HARBOR_PASSWORD: ${{ secrets.HARBOR_PASSWORD }}
      PUBLIC_CHART_URL: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v4.0.1

      - name: Show Helm version
        run: helm version

      - name: Login to Harbor OCI registry
        run: |
          echo "${HARBOR_PASSWORD}" | helm registry login "${HARBOR_URL}" \
            --username "${HARBOR_USERNAME}" \
            --password-stdin

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq \
            https://github.com/mikefarah/yq/releases/download/v4.44.3/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Capture chart metadata
        id: chart_meta
        run: |
          CHART_NAME=$(yq '.name' Chart.yaml)
          CHART_VERSION=$(yq '.version' Chart.yaml)

          echo "chart_name=${CHART_NAME}" >> "${GITHUB_OUTPUT}"
          echo "chart_version=${CHART_VERSION}" >> "${GITHUB_OUTPUT}"
          echo "chart_tgz=${CHART_NAME}-${CHART_VERSION}.tgz" >> "${GITHUB_OUTPUT}"

      - name: Package Helm chart
        run: |
          CHART_NAME="${{ steps.chart_meta.outputs.chart_name }}"
          CHART_VERSION="${{ steps.chart_meta.outputs.chart_version }}"

          echo "Chart name: ${CHART_NAME}"
          echo "Chart version: ${CHART_VERSION}"

          helm package . --version "${CHART_VERSION}"

          ls -1 *.tgz

      - name: Push Helm chart as OCI artifact
        run: |
          CHART_TGZ="${{ steps.chart_meta.outputs.chart_tgz }}"

          if [ ! -f "${CHART_TGZ}" ]; then
            echo "Chart package ${CHART_TGZ} not found"
            exit 1
          fi

          echo "Pushing ${CHART_TGZ} to oci://${HARBOR_URL}/dedicated-server"
          helm push "${CHART_TGZ}" "oci://${HARBOR_URL}/dedicated-server"

      - name: Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish chart to GitHub Pages
        env:
          CHART_TGZ: ${{ steps.chart_meta.outputs.chart_tgz }}
        run: |
          cp "${CHART_TGZ}" gh-pages/
          helm repo index gh-pages --url "${PUBLIC_CHART_URL}"

          cd gh-pages
          if git status --porcelain | grep .; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add .
            git commit -m "chore: publish Helm chart to GitHub Pages"
            git push origin gh-pages
          else
            echo "No changes to publish on gh-pages."
          fi
