name: Publish Helm chart to Harbor (OCI)

on:
  push:
    branches:
      - main
    paths:
      - "Chart.yaml"
      - "values.yaml"
      - "templates/**"
      - ".github/workflows/publish-helm-oci.yaml"
  workflow_dispatch: {}

jobs:
  publish-helm-chart:
    runs-on: ubuntu-latest

    env:
      HARBOR_URL: ${{ secrets.HARBOR_URL }}
      HARBOR_USERNAME: ${{ secrets.HARBOR_USERNAME }}
      HARBOR_PASSWORD: ${{ secrets.HARBOR_PASSWORD }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v4.0.1

      - name: Show Helm version
        run: helm version

      - name: Login to Harbor OCI registry
        run: |
          echo "${HARBOR_PASSWORD}" | helm registry login "${HARBOR_URL}" \
            --username "${HARBOR_USERNAME}" \
            --password-stdin

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq \
            https://github.com/mikefarah/yq/releases/download/v4.44.3/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Package Helm chart
        run: |
          CHART_NAME=$(yq '.name' Chart.yaml)
          CHART_VERSION=$(yq '.version' Chart.yaml)

          echo "Chart name: ${CHART_NAME}"
          echo "Chart version: ${CHART_VERSION}"

          helm package . --version "${CHART_VERSION}"

          ls -1 *.tgz

      - name: Push Helm chart as OCI artifact
        run: |
          CHART_NAME=$(yq '.name' Chart.yaml)
          CHART_VERSION=$(yq '.version' Chart.yaml)

          CHART_TGZ="${CHART_NAME}-${CHART_VERSION}.tgz"

          if [ ! -f "${CHART_TGZ}" ]; then
            echo "Chart package ${CHART_TGZ} not found"
            exit 1
          fi

          echo "Pushing ${CHART_TGZ} to oci://${HARBOR_URL}/helm"
          helm push "${CHART_TGZ}" "oci://${HARBOR_URL}/helm"

